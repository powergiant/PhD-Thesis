\section{The Perturbation Expansion}
In this section, we calculate the approximation series and introduce Feynman diagrams to represent terms in this series. Then we bound the error of this approximation by the bootstrap method, assuming several propositions about the upper bounds of higher order terms. We will prove these propositions in the rest part of the chapter.


\subsection{The approximation series and Feynman diagrams}\label{sec.appFey} In this section, we derive the equation for Fourier coefficients and construct the approximate solution. 

\subsubsection{The Equation of Fourier coefficients}

Let $\psi_k$ be the Fourier coefficient of $\psi$. Then in term of $\psi_k$ equation (\ref{eq.MKDV.threewave}) becomes
\begin{equation}\label{eq.mainfourier.threewave}
\begin{cases}
 \dot{\psi}_{k} =  i\Lambda(k) \psi_k -\nu |k|^2 \psi_k
 +\frac{i\lambda}{L^{d}} \sum\limits_{\substack{(k_1,k_2) \in (\mathbb{Z}^d_L)^2 \\ k_1 + k_2 = k}} k_{x}\psi_{k_1} \psi_{k_2}  \\[2em]
\psi_k(0) = \xi_k = \sqrt{n_{\textrm{in}}(k)} \, \eta_{k}(\omega)
\end{cases}
\end{equation}

Define the linear profile by
\begin{equation}
\phi_k(t):= e^{-i\Lambda(k) t}  \psi_k(t)    
\end{equation}

Rewriting \eqref{eq.mainfourier.threewave} in terms of $\phi_k$ gives  

\begin{equation}\label{eq.mainlinearprofile.threewave}
\begin{split}
\dot{\phi}_{k} 
= -\nu |k|^2 \phi_k + \frac{i\lambda}{L^{d}} \sum\limits_{S(k_1,k_2,k)=0}k_{x}\phi_{k_1} \phi_{k_2}e^{i t\Omega(k_1,k_2,k)}
\end{split}
\end{equation}
where
\begin{equation}
\begin{split}
    &S(k_1,k_2,k) = k_1 + k_2 - k,
    \\
    &\Omega(k_1,k_2,k) =\Lambda(k_1)+\Lambda(k_2)-\Lambda(k).
\end{split}
\end{equation}

We will work with \eqref{eq.mainlinearprofile.threewave} in the rest part of this chapter. 




Integrating (\ref{eq.mainlinearprofile.threewave}) gives

\begin{equation}\label{eq.intmain.threewave}
\begin{split}
    \phi_k =\xi_k+
    \underbrace{\frac{i\lambda}{L^{d}} \sum\limits_{S(k_1,k_2,k)=0}\int^{t}_0k_{x}\phi_{k_1} \phi_{k_2}e^{i s\Omega(k_1,k_2,k)- \nu|k|^2(t-s)} ds}_{\mathcal{T}(\phi,\phi)_k}.  
\end{split}
\end{equation}


Denote the second term on the right hand side by $\mathcal{T}(\phi,\phi)_k$. Denote the right hand side by $\mathcal{F}(\phi)_k=\xi_k+\mathcal{T}(\phi,\phi)_k$. With these notations, \eqref{eq.intmain.threewave} becomes  $\phi=\mathcal{F}(\phi)_k$. 

We construct the approximation series by iteration: $\phi=\mathcal{F}(\phi)=\mathcal{F}(\mathcal{F}(\phi))=\mathcal{F}(\mathcal{F}(\mathcal{F}(\phi)))=\cdots$. To estimate this approximation series, we need a compact graphical notation to represent the huge amount of terms generated from iteration. This is done by introducing the concept of Feynman diagrams.

\subsubsection{Some basic definitions from graph theory} In this section, we introduce the concept of binary trees, branching nodes, leaves, subtrees, node decoration
%sign of a node
and expanding leaves.

\begin{defn}
\begin{enumerate}
    \item \textbf{Binary trees:} A \underline{binary tree} $T$ is a tree in which each node has $2$ or $0$ children. An example of binary trees used in this chapter is shown in Figure \ref{fig.decsub}.
    \item \textbf{Branching nodes:} A \underline{branching node} in a binary tree is a node which has $2$ children. The number of all branching nodes in a tree $T$ is denoted by $l(T)$. In Figure \ref{fig.decsub}, $l(T)=2$.
    \item \textbf{Leaves:} A \underline{leaf} of a tree $T$ is a node which has no child. In Figure \ref{fig.decsub}, all $\star$ nodes and $\Box$ nodes are leaves.
    \item \textbf{Subtrees:} If any child of any node in a subset $T'$ of a tree $T$ is also contained in $T'$ then $T' $ also forms a tree, we call $T'$ a \underline{subtree} of $T$. If the root node of $T'$ is $\mathfrak{n}\in T$, we say $T'$ is the \underline{subtree rooted at $\mathfrak{n}$} or \underline{subtree of $\mathfrak{n}$} and denote it by $T_\mathfrak{n}$. In Figure \ref{fig.decsub}, the tree inside the box is the subtree rooted at node $\bullet$.
     \item \textbf{Node decoration:} In Figure \ref{fig.decsub}, each node is associated with a symbol in $\{\bullet,\ \star,\ \Box\}$. If a node $\mathfrak{n}$ has symbol $\bullet$ (similarly $\star,\ \Box$), we say $\mathfrak{n}$ is decorated by $\bullet$ ($\star,\ \Box$) or $\mathfrak{n}$ has decoration $\bullet$ ($\star,\ \Box$). In what follows, we adopt the convention that leaves always have decoration $\star$ or $\Box$ and nodes other than leaves always have decoration $\bullet$.
     
    \begin{figure}[H]
    \centering
    \scalebox{0.5}{
    \begin{tikzpicture}[level distance=80pt, sibling distance=100pt]
        \draw node[fillcirc](1) {}
            child {node[fillcirc] (2) {}
                   child {node[draw, minimum size=0.4cm] (5) {}}
                   child {node[draw, minimum size=0.4cm] (6) {}}
                  }
            child {node[fillstar] (3) {}};
        \node[rectangle, draw, minimum width = 5cm, minimum height = 4cm] at (-1.8,-4.2) {}; 
    \end{tikzpicture}
    }
    \caption{Subtrees and node decoration.}
    \label{fig.decsub}
    \end{figure}

    
    \item \textbf{Expanding and final leaves:} Leaves denoted by $\Box$ are called \underline{expanding leaves}. Other leaves denoted by $\star$ are called \underline{final leaves}. The notion of expanding leaves is useful in the construction of trees, in which the presence of $\Box$ means that the construction is not finishing and $\Box$ denotes leaves that may be replaced by a branching node later.
    
    The concept of expanding leaves and $\Box$ is only used in this section, so the readers can safely forget it after that section.
\end{enumerate}

    
    % \begin{forest}[$\circ$ [$\bullet$ [$\times$] [$\times$] [$\times$]] [$*$] [$*$] ]
    % \end{forest}


\end{defn}





\subsubsection{Connection between iteration and trees}\label{sec.connection} In this section, we explain non-rigorously the connection between perturbation expansion and trees. Rigorous argument can be find in the next section. 

This iteration process can be described as the following, 
\begin{equation*}
\begin{split}
    \phi=&\mathcal{F}(\phi)=\xi+\mathcal{T}(\phi,\phi)
    \\
    =&\xi+\mathcal{T}\Big(\xi+\mathcal{T}(\phi,\phi),
    \cdots\Big)=\xi+\mathcal{T}(\xi,\xi)+\mathcal{T}\Big(\mathcal{T}(\phi,\phi),
    \xi\Big)\cdots
    \\
    =&\xi+\mathcal{T}(\xi,\xi)+\mathcal{T}(\mathcal{T}(\xi,\xi),\xi)
    +\mathcal{T}(\xi,\mathcal{T}(\xi,\xi))+\cdots
\end{split}    
\end{equation*}
In the above iteration, we recursively choose one $\phi$, replace it by $\xi+\mathcal{T}(\phi,\phi)$ and use the linearity of $\mathcal{T}$ to expand into two terms.
\begin{equation}\label{eq.termgeneration.threewave}
\begin{split}
    &\mathcal{T}\Big(\cdots,\mathcal{T}(\mathcal{T}(\xi,\underline{\phi}),\cdots)\Big)\rightarrow \mathcal{T}\Big(\cdots,\mathcal{T}(\mathcal{T}(\xi,\underline{\xi+\mathcal{T}(\phi,\phi)}),\cdots)\Big)
    \\
    =& \underbrace{\mathcal{T}\Big(\cdots,\mathcal{T}(\mathcal{T}(\xi,\underline{\xi}),\cdots)\Big)}_{I}
    +\underbrace{\mathcal{T}\Big(\cdots,\mathcal{T}(\mathcal{T}(\xi,\underline{\mathcal{T}(\phi,\phi)}),\cdots)\Big)}_{II}
\end{split}        
\end{equation}
Here $I$ and $II$ are obtained by replacing $\phi$ by $\xi$ and $\mathcal{T}(\phi,\phi)$ respectively.

In summary, all terms in the expansion can be generated by following steps

\begin{itemize}
    \item \textbf{Step $0$.} Add a term $\phi$ in the summation $\mathcal{J}$.
    \item \textbf{Step $i$ ($i\ge 1$).} Assume that \textbf{Step $i-1$} has been finished which produces a sum of terms $\mathcal{J}$, then choose a term in $\mathcal{J}$ which has least number of $\xi$ and $\phi$, remove this term from $\mathcal{J}$ and add the two terms in $\mathcal{J}$ constructed in \eqref{eq.termgeneration.threewave}.
\end{itemize}

This process is very similar to the construction of binary trees, in which we recursively replace a chosen expanding node by a leaf or branching node.

\begin{itemize}
    \item \textbf{Step $0$.} Start from a expanding root node $\Box$.
    
    \item \textbf{Step $i$ ($i\ge 1$).} Assume that we have finish the \textbf{Step $i-1$} which produces a collection of trees $\mathscr{T}$, then choose a tree in $\mathscr{T}$ which has least number of expanding leaves $\Box$ and final leaves $\star$, remove this tree from $\mathscr{T}$ and add two new trees in $\mathscr{T}$. In these two new trees, we replace a expanding leaf $\Box$ by a final leaf $\star$ or a branching node $\bullet$ with two expanding children leaves $\Box$. This construction is illustrated by Figure \ref{fig.construction}.
    \begin{figure}[H]
    \centering
    \scalebox{0.5}{
    \begin{tikzpicture}[level distance=80pt, sibling distance=100pt]
        \draw node[fillcirc](1) {} 
            child {node[draw, minimum size=0.4cm] (2) {}}
            child {node[fillstar] (3) {}};
        \node[draw, single arrow,
              minimum height=33mm, minimum width=8mm,
              single arrow head extend=2mm,
              anchor=west, rotate=0] at (4,-1.5) {};  
        \node[scale=3.0] at (16,-2.9) {,};
        \node[fillcirc](4) at (12,0) {} 
            child {node[fillstar] (5) {}}
            child {node[fillstar] (6) {}};
        \node[fillcirc](7) at (22,1.5) {} 
            child {node[fillcirc] (8) {}
                child {node[draw, minimum size=0.4cm] (5) {}}
                child {node[draw, minimum size=0.4cm] (6) {}}
                }
            child {node[fillstar] (9) {}};    
    \end{tikzpicture}
    }
    \caption{One step in the construction of binary trees}
    \label{fig.construction}
    \end{figure}
    % \begin{figure}
    %     \begin{forest}[$\bullet$ [$\times$] [$*$] [$*$] ]
    %     \end{forest}
    % \end{figure}
    % \begin{figure}
    %     \begin{forest}[$\bullet$ [$*$] [$*$] [$*$] ]
    % \end{forest}
    % \end{figure}
    % \begin{figure}
    %     \begin{forest}[$\bullet$ [$\bullet$ [$\times$] [$\times$] [$\times$]] [$*$] [$*$] ]
    % \end{forest}
    % \end{figure}
    

    
% \begin{tikzpicture}
%     \matrix (m)[matrix of math nodes]
%         {
%     & \begin{forest}[$\bullet$ [$\times$] [$\bullet$] [$\bullet$] ]
%         \end{forest} & \qquad & \begin{forest}[$\bullet$ [$\bullet$] [$\bullet$] [$\bullet$] ]
%         \end{forest} & \quad & \begin{forest}[$\bullet$ [$\bullet$ [$\bullet$] [$\bullet$] [$\bullet$]] [$\bullet$] [$\bullet$] ]
%         \end{forest}  \\
% };
% \draw[thick, ->] (m-1-2) -- (m-1-4);
%         \centering
%     \end{tikzpicture}
\end{itemize}


By comparing the above two process, we can make the connection between terms and trees more explicit. Each node $\bullet$ other than leaf in the tree $T$ corresponds to a $\mathcal{T}(\cdots,\cdots)$ in a term $\mathcal{J}_{T}$. Each final leaf $\star$ and expanding leaf $\Box$ corresponds to $\xi$ and $\phi$ respectively. The \textbf{Step} $i$ of replacing $\phi$ by $\xi$ or $\mathcal{T}(\phi,\phi)$ corresponds to replacing $\Box$ by $\star$ or a branching node with two children $\Box$.

We have following recursive formula for calculating a term $\mathcal{J}_T$ from a binary tree $T$. 

If $T$ has only one node then $\mathcal{J}_T=\xi$. Otherwise let $\bullet_1$, $\bullet_2$ be two children of the root node $\bullet$, let $T_{\bullet_1}$, $T_{\bullet_2}$ be the subtrees of $T$ rooted at the above nodes. If $\mathcal{J}_{T_{\bullet_1}}$, $\mathcal{J}_{T_{\bullet_2}}$ have been recursively calculated, then $\mathcal{J}_T$ can be calculated by
\begin{equation}\label{eq.treeterm'.threewave}
    \mathcal{J}_T=\mathcal{T}(\mathcal{J}_{T_{\bullet_1}}, \mathcal{J}_{T_{\bullet_2}}).
\end{equation}

The formal power series obtained by iterating $\phi=\mathcal{F}(\phi)$ can be calculated from trees by $\sum_{T\in \mathscr{T}} \mathcal{J}_T$.

Let $l(T)$ be the number of branching nodes in $T$, then it can be shown that $\mathcal{J}_T$ is a degree $l(T)+1$ polynomial of $\xi$. We define the approximation series to be a finite degree truncation of the formal power series which equals to $\sum_{l(T)\le N} \mathcal{J}_T$.


\subsubsection{Feynman diagrams and construction of the approximation solution} In this section we present the rigorous argument equivalent to that in the above section. 

In the construction of trees, finally all $\Box$ nodes will be replaced by $\bullet$, $\star$, so in what follows we only consider trees whose nodes are decorated by $\bullet$, $\star$.

\begin{defn}\label{def.treeterms} Given a binary tree $T$ whose nodes are decorated by $\bullet$, $\star$,
% if the sign of the root is $+$, 
we inductively define the quantity $\mathcal{J}_T$ by:
\begin{equation}\label{eq.treeterm.threewave}
    \mathcal{J}_T=
    \begin{cases}
    \xi, \qquad\qquad\quad\  \textit{ if $T$ has only one node $\star$.}
    \\
    \mathcal{T}(\mathcal{J}_{T_{\mathfrak{n}_1}}, \mathcal{J}_{T_{\mathfrak{n}_2}}), \textit{ otherwise.}
    \end{cases}
\end{equation}
Here $\mathfrak{n}_1$, $\mathfrak{n}_2$ are two children of the root node $\mathfrak{r}$ and $T_{\mathfrak{n}_1}$, $T_{\mathfrak{n}_2}$ are the subtrees of $T$ rooted at the these nodes.
\end{defn}

\begin{defn}
Given a large number $N$, define the approximate solution $\phi_{app}$ by
\begin{equation}\label{eq.approxsol.threewave}
    \phi_{app}=\sum_{l(T)\le N} \mathcal{J}_T
\end{equation}
\end{defn}

Section \ref{sec.connection} explains why the approximation series should equals to \eqref{eq.approxsol.threewave}, a sum of many tree terms, but if we know this fact, we can directly prove it, and forget all the motivations. The lemma below proves that $\phi_{app}$ defined by the above expression is an approximate solution.  

\begin{lem}\label{lem.approxerror} Define 
\begin{equation}
    Err=\mathcal{F}(\phi_{app})-\phi_{app},
\end{equation}
then we have 
\begin{equation}\label{eq.approxerror.threewave}
    Err=\sum_{T\in \mathcal{T}_{>N}^*} \mathcal{J}_T,
\end{equation}
where $\mathcal{T}_{>N}^*$ is defined by
\begin{equation}
\begin{split}
    \mathcal{T}_{>N}^*=\{&T:l(T)>N,\ l(T_{\mathfrak{n}_1})\le N,
    l(T_{\mathfrak{n}_2})\le N,
    \\
    &\textit{$T_{\mathfrak{n}_1}$, $T_{\mathfrak{n}_2}$ are the subtrees defined in Definition \ref{def.treeterms}} \}
\end{split}
\end{equation}
\end{lem}

\begin{rem}
Notice that all terms in $\sum_{T\in \mathcal{T}_{>N}^*}$ are polynomials of $\xi$ of degree $>N$. Therefore, the approximation error of $\phi_{app}$ is of very high order, which proves that $\phi_{app}$ is an appropriate approximation solution. 
\end{rem}

\begin{proof} By \eqref{eq.approxsol.threewave}, we get
\begin{equation}\label{eq.lemapproxerror.threewave}
\begin{split}
    Err=&\mathcal{F}(\phi_{app})-\phi_{app}    
    \\
    =&\xi+\mathcal{T}(\phi_{app},\phi_{app})-\phi_{app}
    \\
    =&\xi+\sum_{l(T_1),l(T_2)\le N} \mathcal{T}(\mathcal{J}_{T_1},\mathcal{J}_{T_2})-\sum_{l(T)\le N} \mathcal{J}_T
\end{split}
\end{equation}

Let $T$ be a tree constructed by connecting the root nodes $\mathfrak{n}_1$, $\mathfrak{n}_2$ of $T_1$, $T_2$ to a new node $\mathfrak{r}$. We define $\mathfrak{r}$ to be the root node of $T$.

Then by \eqref{eq.treeterm.threewave}, we have
\begin{equation}
    \mathcal{J}_T=\mathcal{T}(\mathcal{J}_{T_1}, \mathcal{J}_{T_2})
\end{equation}
and 
\begin{equation}
    \sum_{l(T_1),l(T_2)\le N} \mathcal{T}(\mathcal{J}_{T_1},\mathcal{J}_{T_2})=\sum_{\substack{l(T)\ge 1\\ l(T_1),l(T_2)\le N}} \mathcal{J}_{T}
\end{equation}

By \eqref{eq.lemapproxerror.threewave}, we get
\begin{equation}
\begin{split}
    Err=&\xi+\sum_{\substack{l(T)\ge 1\\ l(T_1),l(T_2)\le N}} \mathcal{J}_{T}-\sum_{l(T)\le N} \mathcal{J}_T
    \\
    =&\sum_{\substack{T_1,T_2\text{ are subtrees of }\mathfrak{r}\\ l(T_1),l(T_2)\le N}} \mathcal{J}_{T}-\sum_{\substack{T_1,T_2\text{ are subtrees of }\mathfrak{r}\\l(T)\le N\\ l(T_1),l(T_2)\le N}} \mathcal{J}_T.
    \\
    =&\sum_{T\in \mathcal{T}_{>N}^*} \mathcal{J}_T
\end{split}
\end{equation}
Here in the second equality, we use the fact that $\sum_{l(T)\le N}=\sum_{\substack{l(T)\le N\\ l(T_1),l(T_2)\le N}}$.

Therefore, we complete the proof of this lemma.
\end{proof}

\subsection{Estimates of the approximation solution}

\subsubsection{Estimates of tree terms} By \eqref{eq.approxerror.threewave}, in order to control the approximation error $Err$, it suffices to get upper bounds of tree terms $\mathcal{J}_T$. We state the upper bound in the proposition below and delay its proof to section \ref{sec.treetermsupperbound}.

Let us introduce a definition before state the proposition.

\begin{defn}\label{def.Lcertainly}
Given a property $A$, we say $A$ happens $L$-certainly if the probability that $A$ happens satisfies $P(A)\ge 1-Ce^{-L^\theta}$ for some $C, \theta>0$.
\end{defn}

\begin{prop}\label{prop.treetermsupperbound}
We have $L$-certainly for any $\theta$ that 
\begin{equation}\label{eq.treetermsupperbound.threewave}
    \sup_t\sup_k  |(\mathcal{J}_T)_k|\lesssim L^{O(l(T)\theta)} \rho^{l(T)}.
\end{equation}
and $(\mathcal{J}_T)_k=0$ if $|k|\gtrsim 1$. Here $(\mathcal{J}_T)_k$ is the Fourier coefficients of $\mathcal{J}_T$ and \begin{equation}
    \rho=\alpha\, T^{\frac{1}{2}}_{\text{max}}.
\end{equation}
\end{prop}

\subsubsection{Linearization around the approximation solution} Let $w=\phi-\phi_{app}$ be the deviation of $\phi_{app}$ to the true solution $\phi_{app}$. In order to estimate $w$, we consider the linearized equation of
\begin{equation}
    \phi=\mathcal{F}(\phi)=\xi+\mathcal{T}(\phi,\phi).
\end{equation}
The linearized equation is a equation of $w$ given by
\begin{equation}\label{eq.eqw.threewave}
    w= Err(\xi)+Lw+B(w,w),
\end{equation}
where $Err(\xi)$, $Lw$, $B(w,w)$ are given by
\begin{equation}
\left\{
\begin{aligned}
    &Err=\mathcal{F}(\phi_{app})-\phi_{app},
    \\
    &Lw=2\mathcal{T}(\phi_{app},w),
    \\
    &B(w,w)=\mathcal{T}(w,w).
\end{aligned}\right.
\end{equation}

As explained in section \ref{sec.randmatintro}, to control $w$, we need operator norm bound $||L^K||_{X^p}$. Notice that $\phi_{app}=\sum_{l(T)\le N} \mathcal{J}_T$, so we know that $Lw$ is a sum of terms like $\mathcal{T}(\mathcal{J}_{T},w)$.

It suffices to get following operator norm bound for $w\rightarrow \mathcal{T}(\mathcal{J}_{T},w)$ in order to upper bound $L^K$.

\begin{prop}\label{prop.operatorupperbound}
Define $\rho=\alpha\, T^{\frac{1}{2}}_{\text{max}}$ as in Proposition \ref{prop.treetermsupperbound} and $\mathcal{P}_{T}$ to be the linear operator
\begin{equation}
\begin{split}
    w\rightarrow \mathcal{T}(\mathcal{J}_{T},w).
\end{split}
\end{equation} 
Then for any sequence of trees $\{T_1,\cdots,T_K\}$, we have $L$-certainly for any $\theta$ the operator bound
\begin{equation}\label{eq.operatornorm'.threewave}
    \left|\left|\prod_{j=1}^K\mathcal{P}_{T_j}\right|\right|_{L_t^{\infty}X^p\rightarrow L_t^{\infty}X^p}\le L^{O\left(1+\theta\sum_{j=1}^K l(T_j)\right)} \rho^{\sum_{j=1}^K l(T_j)}.
\end{equation}
for any $T_j$ with $l(T_j)\le N$. 

The the above inequality implies that 
\begin{equation}\label{eq.operatornorm.threewave}
    \left|\left|L^K\right|\right|_{L_t^{\infty}X^p\rightarrow L_t^{\infty}X^p}\le L^{O(1+K\theta)} \rho^{K}.
\end{equation}
\end{prop}

The proof of this proposition can be found in section \ref{sec.randommatrices}.
\subsection{Bound the error of the approximation}\label{sec.errorw}

Define $w=v-v_{app}$ to be the approximation error. In this section we prove the following theorem that gives an upper bound of $w$, assuming Proposition \ref{prop.treetermsupperbound} and Proposition \ref{prop.operatorupperbound} in previous section.


\begin{thm}\label{th.app}
Let $w=\phi-\phi_{app}$. Given any $M\gg 1$, there exists $N$ such that if $\phi_{app}$ is the $N$-th order approximate solution, then $\sup_{t\le T_{\text{max}}}||w(t)||_{X^p}\lesssim L^{-M}$ $L$-certainly (with probability $\geq 1-Ce^{-CL^\theta}$).
\end{thm}

\begin{proof}
If for some $C$ sufficiently large we can show that

\begin{equation}\label{eq.claimw.threewave}
    \sup _{t\le T}||w(t)||_{X^p}\le CL^{-M}\textit{  implies that } \sup _{t\le T}||w(t)||_{X^p}< CL^{-M},
\end{equation}
for all $T\le T_{\text{max}}$, then we finish the proof of this theorem. 

Here is the explanation. \eqref{eq.claimw.threewave} implies that if we define the set $A=\{T: \sup _{t\le T}||w||_{X^p}\le CL^{-M}\}$ then the set equals to $\{T: \sup _{t\le T}||w||_{H^s}< CL^{-M}\}$ which is open. The original definition $A=\{T: \sup _{t\le T}||w||_{X^p}\le CL^{-M}\}$ implies that this set is also closed. It is nonempty because $||w(0)||_{X^p}=0$ implies that $0\in A$. Therefore, $A$ is open, closed and nonempty in $[0,T_{\text{max}}]$, so $A=[0,T_{\text{max}}]$ which implies that the theorem.

Now we prove (\ref{eq.claimw.threewave}). By \eqref{eq.eqw.threewave}, 
\begin{equation}
    w-Lw= Err(\xi)+B(w,w).
\end{equation}
By Neumann series we have
\begin{equation}\label{eq.maintheoremeq1.threewave}
    \begin{split}
        w=& (1-L)^{-1}(Err(\xi)+B(w,w))
        \\
        =&(1-L^K)^{-1}(1+L+\cdots+L^{K-1})(Err(\xi)+B(w,w)).
    \end{split}
\end{equation}
Assume that the constant in $O(1+K\theta)$ in \eqref{eq.operatornorm.threewave} is $C_{norm}$. Since $T_{\text{max}}\le L^{-\varepsilon} \alpha^{-2}$, we know that $\rho=\alpha\, T^{\frac{1}{2}}_{\text{max}}\lesssim L^{-\varepsilon}$. Take $\theta\le C_{norm}\varepsilon/2$ and $K\gg \frac{C_{norm}}{\varepsilon}$, then $\left|\left|L^K\right|\right|_{L^{\infty}X^p\rightarrow L^{\infty}X^p}\le L^{C_{norm}(1+K\theta)}\rho^K\lesssim L^{C_{norm}(1+K\theta)} L^{-K\varepsilon}\ll 1$, so we get $\left|\left|L^K\right|\right|_{L^{\infty}X^p\rightarrow L^{\infty}X^p}\ll 1$ and thus $\left|\left|(1-L^K)^{-1}\right|\right|_{L^{\infty}X^p\rightarrow L^{\infty}X^p}\lesssim 1$. 

By \eqref{eq.maintheoremeq1.threewave}, we get
\begin{equation}
    ||w(t)||_{X^p}\lesssim \sum_{j=1}^K||L^j(Err(\xi))||_{X^p}+ ||(1+L+\cdots+L^{K-1})(B(w,w))||_{X^p}
\end{equation}

By \eqref{eq.approxerror.threewave}, we know that $Err$ is a sum of tree terms $\sum_{T\in \mathcal{T}_{>N}^*} \mathcal{J}_T$ of order $\ge N$. Since $L=\sum_{1\le l(T)\le N} \mathcal{P}_{T}$, we know that $L^j(Err(\xi))$ is a sum of terms like $\mathcal{P}_{T_1}\circ\cdots\circ\mathcal{P}_{T_{j}}(\mathcal{J}_T)$ which by \eqref{eq.operatoreqsimpleJ_T.threewave} equals to $\mathcal{J}_{T_1\circ\cdots\circ T_{j}\circ T}$. By Proposition \ref{prop.treetermsupperbound}, we get $||\mathcal{J}_{T_1\circ\cdots\circ T_{j}\circ T}||_{X^p}\lesssim (L^{O(\theta)} \rho)^{l(T_1\circ\cdots\circ T_{j}\circ T)}\lesssim L^{O(l(T)\theta)} \rho^{l(T)}$. Since $\rho=\alpha\, T^{\frac{1}{2}}_{\text{max}}\lesssim L^{-\varepsilon}$ and $l(T)>N$ in the sum of $Err$, we get 
\begin{equation}\label{eq.maintheoremeq2.threewave}
    \sum_{j=1}^K||L^j(Err(\xi))||_{X^p}\lesssim L^{O(N\theta)} \rho^{N}\lesssim L^{O(N\theta)} L^{-N\varepsilon}\ll L^{-M}
\end{equation}
if we take $N\gg M/\varepsilon$ and $\theta\ll \varepsilon$.

Taking $K=1$ in \eqref{eq.operatornorm'.threewave}, we know that $\left|\left|L\right|\right|_{L^{\infty}X^p\rightarrow L^{\infty}X^p}\le L^{O(1)}$, so $\left|\left|L^j\right|\right|_{L^{\infty}X^p\rightarrow L^{\infty}X^p}\le L^{O(K)}$ if $j\le K$. Taking $M\gg K$, by \eqref{eq.claimw.threewave}, we have $\sup _{t\le T}||w(t)||_{X^p}\le CL^{-M}$. Therefore, we have 
\begin{equation}\label{eq.maintheoremeq3.threewave}
    ||(1+L+\cdots+L^{K-1})(B(w,w))||_{X^p}\lesssim L^{O(K)} L^d ||w||^2_{X^p}\lesssim L^{O(K)} L^{O(1)} L^{-2M}\ll L^{-M}.
\end{equation}

Combining \eqref{eq.maintheoremeq2.threewave} and \eqref{eq.maintheoremeq3.threewave}, we prove $\sup _{t\le T}||w(t)||_{X^p}\ll L^{-M} < CL^{-M}$ from the assumption that $\sup _{t\le T}||w(t)||_{X^p}\le CL^{-M}$. We thus complete the proof of Theorem \ref{th.app}.
\end{proof}


\subsection{Proof of the main theorem}\label{sec.proofmain} In this section, we prove Theorem \ref{th.main}.

\begin{proof}[Proof of Theorem \ref{th.main}] \textbf{Step 1.} ($\mathbb E |\widehat \psi(t, k)|^2$ is close to $\mathbb E |\psi_{app,k}|^2$) By Theorem \ref{th.app}, we know that when $t\le T_{\text{max}}= L^{-\varepsilon}\alpha^{-2}$, we have $||w||_{X^p}\le L^{-M}$ with $L$-certainly. 


The above inequality is equivalent to $\sup_k\, |\langle k \rangle^s w_k|\le CL^{-M}$. Remember that $w:=\psi-\psi_{app}$, so $L$-certainly we have the following estimate
\begin{equation}\label{eq.psikminusxik.threewave}
    \sup_k\, \langle k \rangle^s |\psi_k-\psi_{app,k}|\le CL^{-M}
\end{equation}

Denote by $A$ the event that the above estimate is true, then $\mathbb E |\widehat \psi(t, k)|^2=\mathbb E (|\psi_k|^2 1_{A})+\mathbb E (|\psi_k|^2 1_{A^c})$. $L$-certainty implies that $\mathbb P(A^c) \lesssim e^{-CL^{\theta}}$. Since $||\psi||_{L^2}$ is conservative and $|\psi_k|^2\le L^{d/2} ||\psi||_{L^2}\le L^{d/2}$, we know that $\mathbb E (|\psi_k|^2 1_{A^c})\lesssim L^{d/2} e^{-CL^{\theta}}= O(L^{-M})$. Therefore, $\mathbb E |\widehat \psi(t, k)|^2=\mathbb E (|\psi_k|^2 1_{A})+O(L^{-M})$. Since we also have $\mathbb E |\psi_{app,k}|^2=\mathbb E (|\psi_{app,k}|^2 1_{A})+O(L^{-M})$, we conclude that
\begin{equation}
    \mathbb E |\widehat \psi(t, k)|^2=\mathbb E |\psi_{app,k}|^2+\mathbb E ((|\psi_k|^2-|\psi_{app,k}|^2)1_{A})+O(L^{-M})
\end{equation}

By (\ref{eq.psikminusxik.threewave}), $\mathbb E ((|\psi_k|^2-|\psi_{app,k}|^2)1_{A})=O(L^{-M})$. We may conclude that 
\begin{equation}
    \mathbb E |\widehat \psi(t, k)|^2=\mathbb E |\psi_{app,k}|^2+O(L^{-M}).
\end{equation}
This suggests that we may get the approximation of $\mathbb E |\widehat \psi(t, k)|^2$ by calculating $\mathbb E |\psi_{app,k}|^2$.

\textbf{Step 2.} (Expansion of $\mathbb E |\psi_{app,k}|^2$)
By \eqref{eq.approxsol.threewave}, we know that 
\begin{equation}
    \phi_{app}=\sum_{l(T)\le N} \mathcal{J}_T
\end{equation}

Define 
\begin{equation}\label{eq.n(j).threewave}
    n^{(j)}(k)\coloneq \sum_{l(T)+l(T')=j} \mathbb E \mathcal{J}_{T,k}\overline{\mathcal{J}_{T',k}}
\end{equation}
then Proposition \ref{prop.treetermsupperbound} or \ref{prop.treetermsvariance} gives upper bounds of $n^{(j)}(k)$ , which proves (1) and \eqref{eq.n(j)estimate.threewave} of Theorem \ref{th.main}.


\textbf{Step 3.} (Asymptotics of $n^{(1)}(k)$) The only thing left in Theorem \ref{th.main} is \eqref{eq.n1.threewave}. This is a corollary of Proposition \ref{prop.mainterms}.
\end{proof}
